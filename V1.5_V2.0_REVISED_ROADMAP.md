# 🚀 Claude Code Rewind - Revised Roadmap (v1.5 → v2.0)

## Executive Summary

**Post-CodeRabbit Priority Order**:
1. ✅ **v1.5a**: Web Dashboard (visual timeline)
2. 🔄 **v1.5b**: Real-Time Diff Streaming & Smart Rollback Suggestions (discuss after dashboard)
3. 🎯 **v2.0**: Full Claude Code 2.0 Integration with **Conversational Rewind**

**Key Strategic Shift**: Focus on conversational interface over VSCode extension (now redundant with Claude Code 2.0 native extension)

---

## 📋 v1.5a - Web Dashboard (Post-CodeRabbit)

### Goal
Provide visual, interactive timeline for users who want graphical interface alongside CLI.

### Scope
- FastAPI backend with REST endpoints
- React frontend with D3.js timeline visualization
- Interactive diff viewer with Monaco Editor
- WebSocket for live updates
- Integrated via `claude-rewind serve` and `claude-rewind dashboard`

### Timeline
**3 weeks** (Backend → Frontend → Polish)

### Deliverables
- [ ] FastAPI server with snapshot/diff/rollback endpoints
- [ ] React dashboard with interactive timeline
- [ ] Real-time WebSocket updates
- [ ] CLI integration (`serve`, `dashboard` commands)
- [ ] Documentation and screenshots

---

## 🔄 v1.5b - Real-Time Diff Streaming

### Implemented After Dashboard Complete

#### Real-Time Diff Streaming
**Scope**: Dashboard-integrated live diff streaming as Claude makes changes

**Implementation Approach**:

**Status**: Confirmed for v1.5b implementation

**Note**: Smart Rollback Suggestions will be deferred to v2.0 for conversational integration.

---

## 🎯 v2.0 - Claude Code 2.0 Integration & Conversational Rewind

### Strategic Vision

**Transform Claude Code Rewind from a CLI tool into a conversational safety companion.**

Instead of:
```bash
# Old way
claude-rewind timeline
claude-rewind diff cr_abc123 current
claude-rewind rollback cr_abc123 --selective auth.py
```

Enable:
```bash
# New way - conversational during Claude Code session
User: "Show me what changed in the last hour"
Claude: [Analyzes snapshots conversationally]

User: "I think you broke something, can you find it?"
Claude: [Analyzes recent changes, identifies issue, suggests rollback]

User: "Undo just the auth changes"
Claude: [Executes selective rollback, explains what was reverted]
```

---

### 🏗️ v2.0 Architecture

```
┌─────────────────────────────────────────────────────────┐
│           Claude Code Session (2.0)                      │
│                                                          │
│  User: "Show me what you changed"                       │
│  Claude: [Queries Rewind Agent via conversational API]  │
│                                                          │
└─────────────────────────────────────────────────────────┘
                          ▲
                          │ Conversational API
                          ▼
┌─────────────────────────────────────────────────────────┐
│         Claude Code Rewind Agent (v2.0)                  │
│  - Responds to natural language queries                  │
│  - "What changed?" → timeline summary                    │
│  - "Undo that" → smart rollback                          │
│  - "Show me diffs" → conversational diff explanation     │
└─────────────────────────────────────────────────────────┘
                          ▲
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│        Native Hooks Integration (Event-Driven)           │
│  SessionStart → Initialize Rewind session                │
│  PreToolUse → Capture pre-change state                   │
│  PostToolUse → Create snapshot with rich context         │
│  SubagentStart → Track subagent delegation               │
│  SubagentStop → Snapshot subagent work                   │
│  Error → Auto-suggest rollback                           │
└─────────────────────────────────────────────────────────┘
                          ▲
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│         Existing SnapshotEngine (v1.0)                   │
│         (Enhanced with conversational API layer)         │
└─────────────────────────────────────────────────────────┘
```

---

### 🎯 v2.0 Feature Breakdown

#### 1. **Conversational Rewind Agent**

**Goal**: Natural language interface for all Rewind functionality

**Implementation**:
```python
# claude_rewind/agent/conversational.py
class RewindConversationalAgent:
    """Conversational interface for Claude Code Rewind."""

    def handle_query(self, user_message: str) -> str:
        """Parse natural language and route to appropriate action."""

        intent = self._classify_intent(user_message)

        if intent == "show_timeline":
            return self._generate_timeline_response()
        elif intent == "show_diff":
            return self._generate_diff_response()
        elif intent == "rollback":
            return self._generate_rollback_response()
        elif intent == "analyze_changes":
            return self._analyze_recent_changes()
        elif intent == "find_issue":
            return self._diagnose_issue()

    def _generate_timeline_response(self) -> str:
        """Generate conversational timeline summary."""
        snapshots = self.engine.get_recent_snapshots(limit=10)

        response = "Here's what I changed recently:\n\n"
        for snapshot in snapshots:
            response += f"• {snapshot.timestamp}: {snapshot.description}\n"
            response += f"  Files: {', '.join(snapshot.files)}\n\n"

        return response

    def _diagnose_issue(self) -> str:
        """Analyze recent changes to find potential issues."""
        # Use smart rollback analyzer
        suggestions = self.suggestion_engine.analyze_recent_changes()

        if suggestions:
            best = suggestions[0]
            return f"""
I found a potential issue in snapshot {best.snapshot_id}:
- File: {best.file}
- Change type: {best.change_type}
- Safety score: {best.safety_score}

Would you like me to roll this back?
"""
        else:
            return "I didn't find any obvious issues in recent changes."
```

**Conversational Examples**:

```bash
# Example 1: Timeline Query
User: "What have you changed in the last 30 minutes?"
Claude: "Here's what I changed recently:

• 14:30 - Refactored auth system (auth.py, utils.py)
• 14:25 - Added error handling (api.py)
• 14:20 - Fixed bug in payment processing (payment.py)

Would you like to see detailed diffs for any of these?"

# Example 2: Issue Diagnosis
User: "Something broke after your last changes"
Claude: "Let me analyze recent snapshots...

I found the likely issue in snapshot cr_abc123 (14:30):
- File: auth.py
- Change: Refactored login function
- Impact: 3 dependent files affected
- Safety score: 85%

I recommend rolling back just auth.py to the previous version.
This will preserve your manual changes in other files.

Should I proceed with this selective rollback?"

User: "Yes"
Claude: "✅ Rolled back auth.py to snapshot cr_abc122.
Your manual changes in config.py and README.md are preserved.
The auth system is now restored to its previous state."

# Example 3: Diff Explanation
User: "Explain what changed in that refactoring"
Claude: "In the auth refactoring (cr_abc123), I made these changes:

auth.py:
- Added type hints to login() function
- Extracted validation logic to _validate_credentials()
- Changed error handling from exceptions to Result type

utils.py:
- Added new Result type for better error handling
- Imported from typing module

The changes improved type safety and error handling, but may have
introduced a bug in the validation logic. Would you like to see
the actual diff?"

# Example 4: Smart Rollback
User: "Undo just the auth changes but keep everything else"
Claude: "I'll perform a selective rollback:

Rolling back:
✅ auth.py → restored to cr_abc122
✅ utils.py → partially restored (only auth-related changes)

Preserving:
✓ config.py (your manual edits)
✓ api.py (unrelated to auth)
✓ payment.py (working correctly)

Rollback complete! The auth system is restored while keeping
all other improvements."
```

---

#### 2. **Native Hooks Integration (Event-Driven)**

**Goal**: Replace polling with event-driven architecture using Claude Code 2.0 native hooks

**Current v1.0 Approach** (Polling):
```python
# claude_rewind/hooks/claude_interceptor.py
# Polls for Claude activity via process monitoring
while True:
    if self._is_claude_active():
        self._capture_snapshot()
    time.sleep(1)  # Poll every second
```

**v2.0 Approach** (Event-Driven):
```python
# claude_rewind/hooks/native_hooks.py
from claude_code_sdk import hooks

@hooks.on("PreToolUse")
def on_pre_tool_use(context):
    """Capture state before Claude makes changes."""
    rewind_engine.capture_pre_state(
        tool=context.tool_name,
        prompt=context.prompt,
        session_id=context.session_id
    )

@hooks.on("PostToolUse")
def on_post_tool_use(context):
    """Create snapshot after Claude makes changes."""
    rewind_engine.create_snapshot(
        action_type=context.tool_name,
        tool_context=context,
        rich_metadata={
            'reasoning': context.extended_thinking,
            'subagent': context.subagent_name,
            'confidence': context.confidence_score
        }
    )

@hooks.on("SubagentStart")
def on_subagent_start(context):
    """Track when Claude delegates to subagent."""
    rewind_engine.track_delegation(
        parent_session=context.parent_session,
        subagent=context.subagent_name,
        delegation_reason=context.reason
    )

@hooks.on("SubagentStop")
def on_subagent_stop(context):
    """Capture subagent's work as dedicated snapshot."""
    rewind_engine.create_subagent_snapshot(
        subagent=context.subagent_name,
        changes=context.changes,
        parent_session=context.parent_session
    )

@hooks.on("Error")
def on_error(context):
    """Auto-suggest rollback when Claude encounters error."""
    if context.error_type == "execution_error":
        suggestions = rewind_engine.suggest_rollback_for_error(
            error=context.error,
            recent_snapshots=context.recent_changes
        )

        # Present suggestions conversationally
        claude_response = f"""
I encountered an error. Let me analyze recent changes...

{suggestions[0].explanation}

Should I roll back to fix this?
"""
```

**Benefits**:
- ⚡ **Zero Latency**: Snapshots captured immediately when events fire
- 🎯 **Rich Context**: Full access to tool context, reasoning, subagent info
- 💪 **Reliable**: No polling, no missed actions
- 🔄 **Event-Driven**: React to errors, delegations, user requests in real-time

---

#### 3. **Subagent-Aware Snapshots**

**Goal**: Track which subagent made which changes for granular rollback

**Enhanced Snapshot Metadata**:
```python
@dataclass
class SubagentSnapshot(Snapshot):
    """Snapshot with subagent context."""
    subagent_name: str  # "code-reviewer", "api-designer", etc.
    subagent_type: str  # "review", "design", "implement"
    parent_session: str  # Link to main session
    delegation_reason: str  # Why this subagent was invoked
    delegation_chain: List[str]  # Full chain of delegations
```

**Conversational Subagent Rollback**:
```bash
User: "Undo what the code-reviewer changed"
Claude: "I'll rollback changes from the code-reviewer subagent:

Snapshot cr_sub_001 (14:35):
- Added type hints to 5 functions
- Refactored error handling
- Extracted helper functions

Rolling back... ✅ Done!

Note: I'm preserving changes from the api-designer and code-writer
subagents, as those are working correctly."

# Or even more granular:
User: "Keep the type hints but undo the refactoring"
Claude: "I'll perform a surgical rollback:

From code-reviewer snapshot cr_sub_001:
✅ Keeping: Type hint additions
✅ Undoing: Refactoring and helper extraction

This is a partial subagent rollback - I'm cherry-picking the good
parts while removing the problematic refactoring."
```

---

#### 4. **Plan Mode Integration**

**Goal**: Capture plans and validate implementation adherence

**Enhanced Plan Capture**:
```python
@hooks.on("PlanCreated")  # New hook in Claude Code 2.0
def on_plan_created(context):
    """Capture plan as special snapshot type."""
    rewind_engine.create_plan_snapshot(
        plan_document=context.plan_text,
        estimated_files=context.estimated_changes,
        plan_steps=context.steps,
        created_by=context.session_id
    )

@hooks.on("PlanExecutionStart")
def on_plan_execution_start(context):
    """Link implementation to plan."""
    rewind_engine.start_plan_tracking(
        plan_id=context.plan_id,
        implementation_session=context.session_id
    )

@hooks.on("PlanExecutionEnd")
def on_plan_execution_end(context):
    """Validate implementation vs plan."""
    validation = rewind_engine.validate_plan_adherence(
        plan_id=context.plan_id,
        implementation_snapshots=context.snapshots
    )

    if validation.deviation_score > 0.3:
        # Alert user conversationally
        return f"""
⚠️ Implementation deviated from approved plan:

Approved plan expected: {validation.expected_files} files
Actual changes: {validation.actual_files} files

Unexpected changes:
{validation.unexpected_changes}

Should I rollback the deviations and stick to the plan?
"""
```

**Conversational Plan Validation**:
```bash
User: "Did you follow the plan we discussed?"
Claude: "Let me check...

✅ Plan adherence: 92%

Completed as planned:
• Refactored auth system (3 files)
• Added error handling (2 files)
• Updated tests (1 file)

Deviations:
⚠️ Also modified config.py (not in plan)
   Reason: Found a related configuration issue

Would you like me to undo the config.py change to stick strictly
to the plan, or keep it since it's a legitimate fix?"
```

---

#### 5. **Extended Thinking Context Capture**

**Goal**: Preserve Claude's reasoning for future reference

**Reasoning Capture**:
```python
@hooks.on("ExtendedThinkingComplete")
def on_extended_thinking(context):
    """Capture reasoning chain."""
    rewind_engine.attach_reasoning_to_snapshot(
        snapshot_id=context.related_snapshot,
        reasoning_chain=context.thinking_steps,
        decision_factors=context.factors,
        confidence=context.confidence,
        alternatives_considered=context.alternatives
    )
```

**Conversational Reasoning Review**:
```bash
User: "Why did you make that architectural decision?"
Claude: "Let me show you my reasoning from that session:

Extended Thinking (snapshot cr_abc123):

1. Analyzed function complexity: O(n²)
   → Identified nested loops as bottleneck

2. Considered trade-offs:
   • Hash table approach: Fast (O(n)) but uses more memory
   • Optimized loop: Moderate speed, minimal memory
   • Algorithm library: Fastest but adds dependency

3. Decision factors (weighted):
   • Performance priority: 8/10
   • Memory constraint: 6/10
   • Code simplicity: 7/10

4. Conclusion: Hash table approach
   Confidence: 95%

Looking back, this was the right call. Performance improved 10x
and memory usage is acceptable."

User: "What if we had chosen the optimized loop instead?"
Claude: "Good question! Let me analyze the alternative...

If we had used optimized loops instead of hash tables:
• Performance: ~3x improvement (vs 10x with hash table)
• Memory: 50% less usage
• Code complexity: Similar

The hash table was better for our performance-critical use case,
but the optimized loop would have been fine for less frequent
operations. Want me to show you what that code would look like?"
```

---

### 📅 v2.0 Implementation Timeline

#### Phase 1: Conversational Agent Core (Weeks 1-3)
- Week 1: Intent classification and routing
- Week 2: Timeline/diff/rollback conversational responses
- Week 3: Issue diagnosis and smart suggestions

#### Phase 2: Native Hooks Integration (Weeks 4-5)
- Week 4: Hook registration and event handling
- Week 5: Rich context capture (reasoning, subagents, plans)

#### Phase 3: Subagent-Aware Features (Weeks 6-7)
- Week 6: Subagent snapshot metadata
- Week 7: Selective subagent rollback

#### Phase 4: Plan Mode Integration (Week 8)
- Plan capture and validation
- Deviation detection and alerts

#### Phase 5: Extended Thinking Capture (Week 9)
- Reasoning chain storage
- Conversational reasoning review

#### Phase 6: Polish & Testing (Weeks 10-12)
- Comprehensive testing with Claude Code 2.0
- Documentation and tutorials
- Beta testing with community
- v2.0 launch

**Total Duration**: ~3 months

---

### 🎯 v2.0 Success Metrics

#### Conversational Interface
- [ ] 95%+ intent classification accuracy
- [ ] < 1 second response latency for queries
- [ ] Natural, helpful conversational responses
- [ ] User satisfaction > 90%

#### Native Hooks
- [ ] Zero missed actions (100% capture rate)
- [ ] < 50ms event processing latency
- [ ] Rich metadata captured for all snapshots
- [ ] Zero performance impact on Claude Code

#### Subagent Features
- [ ] Accurate subagent attribution (100%)
- [ ] Selective rollback working reliably
- [ ] Delegation chain tracking complete

#### Plan Integration
- [ ] Plan adherence validation accurate
- [ ] Deviation detection within 5%
- [ ] Useful deviation alerts

---

## 🔄 Revised Feature Priority Matrix

| Feature | Version | Priority | Depends On | Duration |
|---------|---------|----------|------------|----------|
| **Web Dashboard** | v1.5a | P0 | ✅ v1.0 Complete | 3 weeks |
| **Real-Time Streaming** | v1.5b | P0 | Web dashboard | 2 weeks |
| **Conversational Agent** | v2.0 | P0 | Real-time streaming | 3 weeks |
| **Native Hooks** | v2.0 | P0 | Conversational agent | 2 weeks |
| **Subagent Snapshots** | v2.0 | P1 | Native hooks | 2 weeks |
| **Smart Suggestions** | v2.0 | P1 | Conversational agent | 2 weeks |
| **Plan Mode Integration** | v2.0 | P2 | Native hooks | 1 week |
| **Extended Thinking** | v2.0 | P2 | Native hooks | 1 week |

**P0** = Critical path to v2.0 conversational rewind
**P1** = High value, can be done in parallel
**P2** = Nice to have, lower priority

---

## 🎯 Strategic Vision Summary

### v1.0 (Complete) ✅
**"Reliable Safety Net"**
- CLI-driven time travel
- Automatic snapshots
- Granular rollback

### v1.5 (Next: Web Dashboard) 🚧
**"Visual Interface"**
- Interactive timeline
- Graphical diff viewer
- Web-based exploration

### v2.0 (Main Goal) 🎯
**"Conversational Time Travel"**
- Natural language queries
- Event-driven capture
- Subagent-aware rollback
- AI-powered suggestions
- Seamless Claude Code 2.0 integration

**Key Insight**: v2.0 transforms Claude Code Rewind from a **tool you use** to a **companion that helps you** during Claude Code sessions.

---

## 📝 Next Steps

1. ✅ **PR #3 Merged into Master** - v1.0 Complete!
2. 🚀 **Start v1.5a: Web Dashboard** (3 weeks)
   - FastAPI backend
   - React frontend
   - WebSocket integration
3. 🔄 **Implement v1.5b: Real-Time Diff Streaming** (2 weeks)
   - Dashboard-integrated live diffs
   - WebSocket streaming from file watcher
   - Real-time visualization as Claude makes changes
4. 🎯 **Begin v2.0: Conversational Rewind** (3 months)
   - Conversational agent core
   - Native hooks integration
   - Subagent awareness
   - Smart rollback suggestions (conversational)
   - Full Claude Code 2.0 integration

---

🤖 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>
